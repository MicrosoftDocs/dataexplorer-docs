%%{ init: { 'flowchart': {'defaultRenderer': 'elk' } } }%%
graph TD
    %% Core Azure AD Entities
    USER[AZUser<br/>Azure AD Users]
    SP[AZServicePrincipal<br/>Service Principals]
    APP[AZApp<br/>Applications]
    GROUP[AZGroup<br/>Security Groups]
    DEVICE[AZDevice<br/>Managed Devices]
    ROLE[AZRole<br/>Azure Roles]
    
    %% Azure Resource Hierarchy
    TENANT[AZTenant<br/>Azure Tenant]
    SUB[AZSubscription<br/>Subscriptions]
    RG[AZResourceGroup<br/>Resource Groups]
    VM[AZVM<br/>Virtual Machines]
    
    %% Azure Resource Containment Hierarchy
    TENANT -->|AZContains| SUB
    TENANT -->|AZContains| USER
    SUB -->|AZContains| RG
    RG -->|AZContains| VM
    
    %% Identity and Access Relationships
    USER -->|AZMemberOf| GROUP
    USER -->|AZOwns| APP
    USER -->|AZOwns| DEVICE
    USER -->|AZOwns| GROUP
    USER -->|AZOwner| SUB
    USER -->|AZOwner| RG
    
    %% Service Principal Relationships
    SP -->|AZRunsAs| APP
    VM -->|AZManagedIdentity| SP
    
    %% Administrative Permissions
    ROLE -->|AZResetPassword| USER
    GROUP -->|AZAddMembers| GROUP
    
    %% High-Volume Permissions (simplified for readability)
    ROLE -.->|AZMGAddOwner<br/>403k edges| RG
    ROLE -.->|AZMGAddSecret<br/>345k edges| APP
    
    %% Styling
    classDef user fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    classDef app fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef group fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef device fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef resource fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef role fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef hierarchy fill:#f1f8e9,stroke:#689f38,stroke-width:2px
    
    class USER user
    class SP,APP app
    class GROUP group
    class DEVICE device
    class VM,RG resource
    class ROLE role
    class TENANT,SUB hierarchy